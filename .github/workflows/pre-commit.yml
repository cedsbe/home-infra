name: Pre-commit

on:
  pull_request:
    branches: [main]
  push:
    branches-ignore: [main]
  workflow_dispatch: # Manual trigger from GitHub UI

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  pre-commit:
    runs-on: ubuntu-latest
    timeout-minutes: 15
    name: Pre-commit checks
    permissions:
      contents: read

    steps:
      - name: Checkout code
        uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Remove git-crypt encrypted files
        run: |
          echo "üîê Removing git-crypt encrypted files (not unlocked in CI)..."
          # Remove files based on .gitattributes patterns
          find . -name "*.secrets.auto.tfvars" -type f -delete
          find . -name "*.secrets.auto.pkrvars.hcl" -type f -delete
          find . -name "backend.config" -type f -delete
          find . -name ".vault_password" -type f -delete
          find . -name ".env" -type f -delete
          find . -name "kubeconfig" -type f -delete
          find . -name "*.key" -type f -delete
          find . -name "*.pem" -type f -delete
          rm -rf ./sensitive/ 2>/dev/null || true
          echo "‚úÖ Encrypted files removed successfully"

      - name: Set up Python
        uses: actions/setup-python@v6
        with:
          python-version: "3.x"

      - name: Install CLI tools
        uses: alexellis/arkade-get@master
        with:
          kubectl: v1.35.0 # renovate: datasource=github-releases depName=kubernetes/kubernetes
          kustomize: v5.8.0 # renovate: datasource=github-releases depName=kubernetes-sigs/kustomize
          kubeconform: v0.7.0 # renovate: datasource=github-releases depName=yannh/kubeconform
          task: v3.46.4 # renovate: datasource=github-releases depName=go-task/task
          tflint: v0.60.0 # renovate: datasource=github-releases depName=terraform-linters/tflint
          terraform: v1.14.3 # renovate: datasource=github-releases depName=hashicorp/packer
          packer: v1.14.3 # renovate: datasource=github-releases depName=hashicorp/terraform

      - name: Install Node.js
        uses: actions/setup-node@v6
        with:
          node-version: "24"

      - name: Install cspell
        run: |
          echo "üìù Installing cspell for spell checking..."
          npm install -g cspell
          cspell --version
          echo "‚úÖ cspell installed successfully"

      - name: Install yamllint
        run: |
          echo "üìã Installing yamllint for YAML validation..."
          pip install yamllint
          echo "‚úÖ yamllint installed successfully"

      - name: Cache pre-commit
        uses: actions/cache@v5
        with:
          path: ~/.cache/pre-commit
          key: pre-commit-${{ runner.os }}-py3.x-${{ hashFiles('.pre-commit-config.yaml') }}-${{ hashFiles('package*.json') }}

      - name: Cache Node.js dependencies
        uses: actions/cache@v5
        with:
          path: ~/.npm
          key: node-${{ runner.os }}-${{ hashFiles('package*.json') }}

      - name: Run pre-commit
        uses: cloudposse/github-action-pre-commit@v4.0.0

      - name: Upload pre-commit logs on failure
        if: failure()
        uses: actions/upload-artifact@v6
        with:
          name: pre-commit-logs
          path: ~/.cache/pre-commit/
          retention-days: 7

  security-scan:
    runs-on: ubuntu-latest
    timeout-minutes: 10
    name: Security scan
    permissions:
      contents: read
      security-events: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Run Trivy vulnerability scanner
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: "config"
          hide-progress: false
          format: "sarif"
          output: "trivy-results.sarif"
          trivy-config: ".github/trivy/trivy.yaml"

      - name: Upload Trivy scan results to GitHub Security tab
        uses: github/codeql-action/upload-sarif@v4
        if: always()
        with:
          sarif_file: "trivy-results.sarif"

      - name: Upload Trivy results as artifact
        uses: actions/upload-artifact@v6
        if: always()
        with:
          name: trivy-results
          path: trivy-results.sarif
          retention-days: 30

      - name: Display Trivy scan summary
        if: always()
        run: |
          echo "üîç Trivy Security Scan Completed"
          echo "================================="
          if [ -f "trivy-results.sarif" ]; then
            echo "‚úÖ SARIF results generated successfully"
            echo "üìä Results uploaded to Security tab (if Code Scanning is enabled)"
            echo "üì¶ Results also available as workflow artifact for 30 days"
          else
            echo "‚ùå SARIF results not found - scan may have failed"
            echo "üí° Check previous steps for errors"
          fi
