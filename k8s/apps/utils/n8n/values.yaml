# n8n Helm Chart Values - Production Configuration
# Chart: oci://8gears.container-registry.com/library/n8n

# Ingress disabled - using Gateway API HTTPRoute instead
ingress:
  enabled: false

# Main n8n application configuration
main:
  # n8n configuration (converted to environment variables)
  config:
    generic:
      timezone: "Europe/Brussels"
    db:
      type: postgresdb
      postgresdb:
        host: n8n-cluster-rw.n8n.svc.cluster.local
        port: 5432
        database: n8n

  # Secrets referenced from external sealed secrets
  # The encryption key and db password are injected via extraEnv
  secret: {}

  # Extra environment variables - reference sealed secrets
  extraEnv:
    N8N_ENCRYPTION_KEY:
      valueFrom:
        secretKeyRef:
          name: n8n-secrets
          key: encryption_key
    DB_POSTGRESDB_USER:
      valueFrom:
        secretKeyRef:
          name: pg-user-credentials
          key: username
    DB_POSTGRESDB_PASSWORD:
      valueFrom:
        secretKeyRef:
          name: pg-user-credentials
          key: password

  # Persistence for n8n data (workflows, credentials cache)
  persistence:
    enabled: true
    type: dynamic
    storageClass: proxmox-csi
    size: 2Gi
    accessModes:
      - ReadWriteOnce

  # Deployment configuration
  replicaCount: 1

  deploymentStrategy:
    type: Recreate

  # Security context matching project patterns
  podSecurityContext:
    runAsNonRoot: true
    runAsUser: 1000
    runAsGroup: 1000
    fsGroup: 1000
    fsGroupChangePolicy: Always
    seccompProfile:
      type: RuntimeDefault

  securityContext:
    allowPrivilegeEscalation: false
    readOnlyRootFilesystem: false
    capabilities:
      drop: ["ALL"]

  # Resource limits
  resources:
    requests:
      cpu: 100m
      memory: 256Mi
    limits:
      cpu: 2000m
      memory: 2Gi

  # Node placement - match project patterns
  nodeSelector:
    topology.kubernetes.io/zone: hsp-proxmox0

  # Service configuration
  service:
    type: ClusterIP
    port: 80

  # Health checks
  livenessProbe:
    httpGet:
      path: /healthz
      port: http
    initialDelaySeconds: 30
    periodSeconds: 10
    timeoutSeconds: 5
    failureThreshold: 6

  readinessProbe:
    httpGet:
      path: /healthz
      port: http
    initialDelaySeconds: 10
    periodSeconds: 5
    timeoutSeconds: 3
    failureThreshold: 3

# Worker disabled for single-instance deployment
# Enable if scaling is needed (requires Redis/Valkey)
worker:
  enabled: false

# Webhook disabled for single-instance deployment
# Enable if separate webhook processing is needed
webhook:
  enabled: false

# Valkey/Redis disabled - not needed for single instance
valkey:
  enabled: false
