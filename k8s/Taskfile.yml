# https://taskfile.dev

version: "3"

tasks:
  bootstrap:gateway-api:
    desc: "Bootstrap the Gateway API"
    dir: infra/crds
    cmds:
      - kubectl kustomize . | kubectl apply -f -

  bootstrap:cilium:
    desc: "Bootstrap Cilium"
    dir: infra/network/cilium
    cmds:
      - kubectl kustomize --enable-helm . | kubectl apply -f -

  bootstrap:sealed-secrets:
    desc: "Bootstrap Sealed Secrets"
    dir: infra/controllers/sealed-secrets
    cmds:
      - kubectl kustomize --enable-helm . | kubectl apply -f -

  bootstrap:sealing-secrets:
    desc: "Seal existing secrets"
    dir: ../sensitive
    cmds:
      - kubeseal -f adguard-users-secrets.yaml -o yaml -w adguard-users-secrets_sealed.yaml
      - kubeseal -f argocd-github-secret.yaml -o yaml -w argocd-github-secret_sealed.yaml
      - kubeseal -f cert-manager-secret.yaml -o yaml -w cert-manager-secret_sealed.yaml
      - cp -f adguard-users-secrets_sealed.yaml ../k8s/infra/network/dns/adguard/secret-users.yaml
      - cp -f argocd-github-secret_sealed.yaml ../k8s/infra/controllers/argocd/argocd-github-secret_sealed.yaml
      - cp -f cert-manager-secret_sealed.yaml ../k8s/infra/controllers/cert-manager/cloudflare-api-token.yaml

  bootstrap:cert-manager:
    desc: "Bootstrap Cert-Manager"
    dir: infra/controllers/cert-manager
    cmds:
      - kubectl kustomize --enable-helm . | kubectl apply -f -

  bootstrap:cilium-gateway:
    desc: "Bootstrap Cilium Gateway Integration"
    dir: infra/network/gateway
    cmds:
      - kubectl kustomize . | kubectl apply -f -

  bootstrap:metrics-server:
    desc: "Bootstrap Talos Metrics Server"
    dir: infra/monitoring/talos-metric-server
    cmds:
      - kubectl kustomize . | kubectl apply -f -

  bootstrap:argo-cd:
    desc: "Bootstrap Argo CD"
    dir: infra/controllers/argocd
    cmds:
      - kubectl kustomize --enable-helm . | kubectl apply -f -

  bootstrap:argo-cd:get-initial-password:
    desc: "Get Argo CD initial admin password"
    cmds:
      - argocd admin initial-password -n argocd

  bootstrap:storage:
    desc: "Bootstrap Storage Classes"
    dir: infra/storage
    cmds:
      - kubectl kustomize . | kubectl apply -f -

  bootstrap:apps-all:
    desc: "Bootstrap all apps"
    dir: apps
    cmds:
      - kubectl kustomize --enable-helm . | kubectl apply -f -

  bootstrap:infra-all:
    desc: "Bootstrap all infra"
    dir: infra
    cmds:
      - kubectl kustomize --enable-helm . | kubectl apply -f -

  argocd:pause:
    desc: "Pause ArgoCD syncing (stops all automated syncs)"
    silent: true
    cmds:
      - task: argocd:status
      - echo "Pausing ArgoCD syncing..."
      - kubectl scale statefulset argocd-application-controller -n argocd --replicas=0
      - kubectl scale deployment argocd-applicationset-controller -n argocd --replicas=0
      - echo "Waiting for controllers to scale down..."
      - kubectl wait --for=delete pod -l app.kubernetes.io/name=argocd-application-controller -n argocd --timeout=60s || echo "No ArgoCD Application Controller pods found"
      - kubectl wait --for=delete pod -l app.kubernetes.io/name=argocd-applicationset-controller -n argocd --timeout=60s || echo "No ArgoCD ApplicationSet Controller pods found"
      - echo "ArgoCD syncing paused - run 'task argocd:resume' to re-enable"
      - echo ""
      - task: argocd:status

  argocd:status:
    desc: "Check ArgoCD controller status"
    silent: true
    cmds:
      - echo "=== Current ArgoCD Application Controller Replicas ==="
      - echo ""
      - echo "=== Application Controller (StatefulSet) ==="
      - kubectl get statefulset argocd-application-controller -n argocd
      - echo ""
      - echo "=== ApplicationSet Controller (Deployment) ==="
      - kubectl get deployment argocd-applicationset-controller -n argocd

  argocd:resume:
    desc: "Resume ArgoCD syncing (re-enables automated syncs)"
    silent: true
    vars:
      ARGOCD_APP_CONTROLLER_REPLICAS: '{{.ARGOCD_APP_CONTROLLER_REPLICAS | default "1"}}'
      ARGOCD_APPSET_CONTROLLER_REPLICAS: '{{.ARGOCD_APPSET_CONTROLLER_REPLICAS | default "1"}}'
    cmds:
      - task: argocd:status
      - echo "Resuming ArgoCD syncing..."
      - kubectl scale statefulset argocd-application-controller -n argocd --replicas={{.ARGOCD_APP_CONTROLLER_REPLICAS}}
      - kubectl scale deployment argocd-applicationset-controller -n argocd --replicas={{.ARGOCD_APPSET_CONTROLLER_REPLICAS}}
      - echo "Waiting for controllers to be ready..."
      - kubectl rollout status statefulset argocd-application-controller -n argocd --timeout=120s
      - kubectl rollout status deployment argocd-applicationset-controller -n argocd --timeout=120s
      - echo "ArgoCD syncing resumed"
      - echo ""
      - task: argocd:status

  seal:secret:
    desc: "Seal a Kubernetes secret file using kubeseal"
    dir: ../sensitive
    vars:
      FILE: '{{.FILE | default ""}}'
      BASE_NAME:
        sh: echo "{{.FILE}}" | sed 's/\.yaml$//'
    requires:
      vars: [FILE]
    cmds:
      - |
        if [ ! -f "{{.FILE}}" ]; then
          echo "Error: File '{{.FILE}}' not found in sensitive folder"
          exit 1
        fi
      - kubeseal -v 3 -f "{{.FILE}}" -o yaml -w "{{.BASE_NAME}}_sealed.yaml"
      - echo "Sealed secret written to {{.BASE_NAME}}_sealed.yaml"
