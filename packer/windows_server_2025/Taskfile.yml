# Taskfile for Windows Server 2025 Packer Template
# https://taskfile.dev

version: "3"

vars:
  DEFAULT_TEMPLATE: DcDesktop
  PACKER_LOG_LEVEL: ""

env:
  PACKER_LOG: "{{.PACKER_LOG_LEVEL}}"

tasks:
  default:
    desc: "Show available tasks"
    silent: true
    cmds:
      - task --list

  validate:
    desc: "Validate Packer template configuration"
    silent: true
    cmds:
      - echo "ğŸ” Validating Packer configuration..."
      - packer validate .
      - echo "âœ… Configuration is valid"

  init:
    desc: "Initialize Packer plugins"
    silent: true
    cmds:
      - echo "ğŸ“¦ Initializing Packer plugins..."
      - packer init .
      - echo "âœ… Plugins initialized"

  env-check:
    desc: "Check if required environment variables are set"
    silent: true
    cmds:
      - |
        echo "ğŸ” Checking required environment variables..."

        # Check if .env file exists
        if [ ! -f ".env" ]; then
          echo "âš ï¸  .env file not found"
          echo "ğŸ’¡ Create one from template:"
          echo "   cp .env.template .env"
          echo "   # Then edit .env with your actual credentials"
          echo ""
        else
          echo "âœ… .env file found"
        fi

        missing_vars=()

        if [ -z "$PKR_VAR_proxmox_api_token" ]; then
          missing_vars+=("PKR_VAR_proxmox_api_token")
        fi

        if [ -z "$PKR_VAR_proxmox_username" ]; then
          missing_vars+=("PKR_VAR_proxmox_username")
        fi

        if [ -z "$PKR_VAR_winrm_password" ]; then
          missing_vars+=("PKR_VAR_winrm_password")
        fi

        if [ ${#missing_vars[@]} -eq 0 ]; then
          echo "âœ… All required environment variables are set"
        else
          echo "âŒ Missing required environment variables:"
          printf '  %s\n' "${missing_vars[@]}"
          echo ""
          echo "ğŸ’¡ Options to set them:"
          echo "   1. Create/update .env file (recommended):"
          echo "      cp .env.template .env"
          echo "      # Edit .env with your credentials"
          echo ""
          echo "   2. Export manually:"
          echo "      export PKR_VAR_proxmox_api_token=\"your-token\""
          echo "      export PKR_VAR_proxmox_username=\"terraform@pve!terra\""
          echo "      export PKR_VAR_winrm_password=\"your-password\""
          exit 1
        fi

  env-check-clone:
    desc: "Check if required environment variables are set for clone build"
    silent: true
    cmds:
      - |
        echo "ğŸ” Checking required environment variables for clone build..."

        # Check if .env file exists
        if [ ! -f ".env" ]; then
          echo "âš ï¸  .env file not found"
          echo "ğŸ’¡ Create one from template:"
          echo "   cp .env.template .env"
          echo "   # Then edit .env with your actual credentials"
          echo ""
        else
          echo "âœ… .env file found"
        fi

        missing_vars=()

        if [ -z "$PKR_VAR_proxmox_api_token" ]; then
          missing_vars+=("PKR_VAR_proxmox_api_token")
        fi

        if [ -z "$PKR_VAR_proxmox_username" ]; then
          missing_vars+=("PKR_VAR_proxmox_username")
        fi

        if [ -z "$PKR_VAR_winrm_password" ]; then
          missing_vars+=("PKR_VAR_winrm_password")
        fi

        if [ -z "$PKR_VAR_clone_vm_id" ]; then
          missing_vars+=("PKR_VAR_clone_vm_id")
        fi

        if [ ${#missing_vars[@]} -eq 0 ]; then
          echo "âœ… All required environment variables are set for clone build"
        else
          echo "âŒ Missing required environment variables for clone build:"
          printf '  %s\n' "${missing_vars[@]}"
          echo ""
          echo "ğŸ’¡ Options to set them:"
          echo "   1. Create/update .env file (recommended):"
          echo "      cp .env.template .env"
          echo "      # Edit .env with your credentials"
          echo ""
          echo "   2. Export manually:"
          echo "      export PKR_VAR_proxmox_api_token=\"your-token\""
          echo "      export PKR_VAR_proxmox_username=\"terraform@pve!terra\""
          echo "      export PKR_VAR_winrm_password=\"your-password\""
          echo "      export PKR_VAR_clone_vm_id=\"vm-id-to-clone\""
          echo ""
          echo "   3. Pass as task variable:"
          echo "      task build-clone PKR_VAR_clone_vm_id=12345"
          echo ""
          echo "â„¹ï¸  The PKR_VAR_clone_vm_id should be the ID of an existing VM template to clone from"
          exit 1
        fi

  setup:
    desc: "Setup environment and check prerequisites"
    silent: true
    deps: [env-check]
    cmds:
      - |
        echo "ğŸ” Checking Packer installation..."
        if ! command -v packer &> /dev/null; then
          echo "âŒ Packer is not installed. Please install Packer first."
          echo "   Visit: https://www.packer.io/downloads"
          exit 1
        fi
        echo "âœ… Packer is installed: $(packer version)"

        echo ""
        echo "ğŸš€ Environment is ready for building Windows Server 2025 templates!"

  setup-clone:
    desc: "Setup environment and check prerequisites for clone build"
    silent: true
    deps: [env-check-clone]
    cmds:
      - |
        echo "ğŸ” Checking Packer installation..."
        if ! command -v packer &> /dev/null; then
          echo "âŒ Packer is not installed. Please install Packer first."
          echo "   Visit: https://www.packer.io/downloads"
          exit 1
        fi
        echo "âœ… Packer is installed: $(packer version)"

        echo ""
        echo "ğŸš€ Environment is ready for building Windows Server 2025 clone templates!"

  build-iso:
    desc: "Build Windows Server 2025 template - Use DEBUG=true to enable breakpoints"
    silent: true
    deps: [setup, validate]
    cmds:
      - |
        echo "ğŸ—ï¸  Building Windows Server 2025 template: {{.TEMPLATE | default .DEFAULT_TEMPLATE}}"

        {{if eq .DEBUG "true"}}
        echo "ğŸ› Debug mode enabled - build will pause at breakpoints"
        echo "ğŸ’¡ Use VNC to connect to the VM during breakpoints"
        {{else}}
        echo "â° This process typically takes 90 - 180 minutes, depending on Windows Updates..."
        {{end}}

        echo ""

        {{if eq .DEBUG "true"}}
        packer build \
          -var 'disable_debug_breakpoints=false' \
          -var 'disable_pre_sysprep_breakpoints=false' \
          -var 'template={{.TEMPLATE | default .DEFAULT_TEMPLATE}}' \
          -only="iso_build.proxmox-iso.windows2025" \
          .
        {{else}}
        packer build -var 'template={{.TEMPLATE | default .DEFAULT_TEMPLATE}}' -only="iso_build.proxmox-iso.windows2025" .
        {{end}}

        echo ""
        echo "âœ… Template build completed successfully!"
        echo "ğŸ“¦ Template available in Proxmox as: template-win2025-{{.TEMPLATE | default .DEFAULT_TEMPLATE}}"

  build-clone:
    desc: "Build Windows Server 2025 clone template - Use DEBUG=true to enable breakpoints"
    silent: true
    deps: [setup-clone, validate]
    cmds:
      - |
        echo "ğŸ—ï¸  Building Windows Server 2025 clone template"

        {{if eq .DEBUG "true"}}
        echo "ğŸ› Debug mode enabled - build will pause at breakpoints"
        echo "ğŸ’¡ Use VNC to connect to the VM during breakpoints"
        {{else}}
        echo "â° This process typically takes 25 - 90 minutes, depending on Windows Updates..."
        {{end}}

        echo ""

        {{if eq .DEBUG "true"}}
        packer build \
          -var 'disable_debug_breakpoints=false' \
          -var 'disable_pre_sysprep_breakpoints=false' \
          -only="clone_build.proxmox-clone.windows2025" \
          .
        {{else}}
        packer build -only="clone_build.proxmox-clone.windows2025" .
        {{end}}

        echo ""
        echo "âœ… Template build completed successfully!"
        echo "ğŸ“¦ Template available in Proxmox as: template-win2025-cloudbase-{{.TEMPLATE | default "custom"}}"

  clean:
    desc: "Clean up Packer cache and temporary files"
    silent: true
    cmds:
      - |
        echo "ğŸ§¹ Cleaning up Packer cache and temporary files..."
        if [ -d "packer_cache" ]; then
          rm -rf packer_cache
          echo "âœ… Removed packer_cache directory"
        fi

        if [ -f "packer.log" ]; then
          rm packer.log
          echo "âœ… Removed packer.log"
        fi

        # Remove any .box files (if any)
        if ls *.box 1> /dev/null 2>&1; then
          rm *.box
          echo "âœ… Removed .box files"
        fi

        echo "âœ… Cleanup completed"

  inspect:
    desc: "Inspect Packer template configuration"
    silent: true
    cmds:
      - |
        echo "ğŸ” Packer Template Configuration:"
        echo "=================================="
        echo ""
        echo "ğŸ“„ Main configuration file:"
        ls -la windows_server_2025.pkr.hcl
        echo ""
        echo "ğŸ“„ Variable files:"
        ls -la variables*.pkr*
        echo ""
        echo "ğŸ“‚ Build files:"
        find build_files -type f | head -10
        echo ""
        echo "ğŸ·ï¸  Available templates:"
        echo "  - DcDesktop    (Datacenter with Desktop Experience)"
        echo "  - DcCore       (Datacenter Core)"
        echo "  - StdDesktop   (Standard with Desktop Experience)"
        echo "  - StdCore      (Standard Core)"
        echo ""
        echo "ğŸ”§ Current configuration:"
        packer inspect .

  logs:
    desc: "Show recent Packer build logs"
    silent: true
    cmds:
      - |
        if [ -f "packer.log" ]; then
          echo "ğŸ“‹ Last 50 lines of packer.log:"
          echo "================================"
          tail -50 packer.log
        else
          echo "âŒ No packer.log found"
          echo "ğŸ’¡ Set PACKER_LOG=1 to enable logging"
        fi

  help:
    desc: "Show detailed help and usage examples"
    silent: true
    cmds:
      - |
        echo "ğŸš€ Windows Server 2025 Packer Template Builder"
        echo "==============================================="
        echo ""
        echo "ğŸ“‹ Common Tasks:"
        echo "  task setup              # Check prerequisites and environment"
        echo "  task validate           # Validate configuration"
        echo "  task build-iso          # Build default template (DcDesktop)"
        echo "  task build-clone        # Build clone template"
        echo "  task clean              # Clean up cache and logs"
        echo ""
        echo "ğŸ—ï¸  Specific Template Builds:"
        echo "  task build-dcdesktop    # Datacenter with Desktop"
        echo "  task build-dccore       # Datacenter Core"
        echo "  task build-stddesktop   # Standard with Desktop"
        echo "  task build-stdcore      # Standard Core"
        echo ""
        echo "ğŸ”§ Custom Template Build:"
        echo "  task build-iso TEMPLATE=DcCore"
        echo "  task build-clone TEMPLATE=custom"
        echo ""
        echo "ğŸ”— Clone Build Requirements:"
        echo "  task env-check-clone                # Check clone-specific environment variables"
        echo "  task build-clone PKR_VAR_clone_vm_id=12345  # Specify source VM ID for cloning"
        echo "  # Note: PKR_VAR_clone_vm_id must be set to an existing VM template ID"
        echo ""
        echo "ğŸ› Debug Options:"
        echo "  task build-iso DEBUG=true          # Enable breakpoints for ISO build"
        echo "  task build-clone DEBUG=true        # Enable breakpoints for clone build"
        echo "  task build-iso DEBUG=true TEMPLATE=DcDesktop   # Debug specific template"
        echo "  PACKER_LOG=1 task build-iso        # Enable verbose logging"
        echo ""
        echo "ğŸ“š More Information:"
        echo "  - See README.md for detailed documentation"
        echo "  - Check variables.auto.pkrvars.hcl for configuration options"
        echo ""
        echo "âš ï¸  Important:"
        echo "  - Create .env file from template: cp .env.template .env"
        echo "  - Edit .env with your actual credentials"
        echo "  - For clone builds, set PKR_VAR_clone_vm_id to an existing VM template ID"
        echo "  - Never commit .env to version control"
        echo "  - Test builds in non-production environment first"
