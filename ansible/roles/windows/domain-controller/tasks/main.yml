---
# Domain Controller role - Main tasks

- name: Validate required variables are set
  ansible.builtin.assert:
    that:
      - ad_safe_mode_password is defined
      - ad_safe_mode_password | length > 0
      - ad_safe_mode_password != "ChangeMe123!"
      - ad_domain_name is defined
      - ad_netbios_name is defined
    fail_msg: "Required AD variables not set. Ensure ad_safe_mode_password is set via vault in group_vars."
    success_msg: "All required AD variables are properly configured."

- name: Install AD DS role
  ansible.windows.win_feature:
    name: AD-Domain-Services
    include_management_tools: true
    state: present
  register: adds_install

- name: Check if domain is already configured
  ansible.windows.win_shell: |
    try {
      $domain = Get-ADDomain -ErrorAction Stop
      Write-Output "Domain configured: $($domain.DNSRoot)"
      exit 0
    } catch {
      if ($_.Exception.Message -like "*Unable to find*" -or $_.Exception.Message -like "*does not exist*") {
        Write-Output "Domain not configured"
        exit 1
      } else {
        Write-Error "Error checking domain: $($_.Exception.Message)"
        exit 2
      }
    }
  register: domain_check
  failed_when: domain_check.rc > 1
  changed_when: false

- name: Install new AD forest
  microsoft.ad.domain:
    dns_domain_name: "{{ ad_domain_name }}"
    safe_mode_password: "{{ ad_safe_mode_password }}"
    domain_netbios_name: "{{ ad_netbios_name }}"
    forest_level: "{{ ad_forest_mode }}"
    domain_level: "{{ ad_domain_mode }}"
    install_dns: "{{ ad_install_dns }}"
  register: domain_install
  when: domain_check.rc != 0
  notify: Reboot after domain installation

- name: Configure DNS forwarders
  ansible.windows.win_shell: |
    {% for forwarder in ad_dns_forwarders %}
    Add-DnsServerForwarder -IPAddress {{ forwarder }}
    {% endfor %}
  when:
    - domain_install.changed
    - ad_dns_forwarders is defined

- name: Display AD configuration status
  ansible.builtin.debug:
    msg: "Active Directory domain {{ ad_domain_name }} is configured"
