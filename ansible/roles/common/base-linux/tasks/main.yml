---
# Base Linux configuration role - Main tasks
# Note: become is handled at playbook/group_vars level

- name: Set timezone
  community.general.timezone:
    name: "{{ timezone }}"

- name: Configure NTP servers
  ansible.builtin.template:
    src: ntp.conf.j2
    dest: /etc/ntp.conf
    mode: "0644"
  notify: Restart ntp

- name: Check if systemd-resolved is active
  ansible.builtin.systemd:
    name: systemd-resolved
  register: resolved_status
  failed_when: false

- name: Configure DNS via systemd-resolved
  ansible.builtin.template:
    src: resolved.conf.j2
    dest: /etc/systemd/resolved.conf
    mode: "0644"
  when:
    - resolved_status.status is defined
    - resolved_status.status.ActiveState == "active"
  notify: Restart systemd-resolved

- name: Configure DNS via NetworkManager
  community.general.nmcli:
    type: ethernet
    conn_name: "{{ ansible_default_ipv4.interface }}"
    dns4: "{{ dns_servers }}"
    state: present
  when:
    - resolved_status.status is not defined or resolved_status.status.ActiveState != "active"
    - ansible_facts.services['NetworkManager.service'] is defined
    - ansible_facts.services['NetworkManager.service'].state == "running"

- name: Configure DNS via resolv.conf (fallback for legacy systems)
  ansible.builtin.template:
    src: resolv.conf.j2
    dest: /etc/resolv.conf
    mode: "0644"
  when:
    - resolved_status.status is not defined or resolved_status.status.ActiveState != "active"
    - ansible_facts.services['NetworkManager.service'] is not defined or ansible_facts.services['NetworkManager.service'].state != "running"

- name: Update package cache
  ansible.builtin.apt:
    update_cache: true
    cache_valid_time: 3600
  when: ansible_os_family == "Debian"

- name: Install common packages
  ansible.builtin.package:
    name: "{{ common_packages }}"
    state: present

- name: Configure SSH
  ansible.builtin.template:
    src: sshd_config.j2
    dest: /etc/ssh/sshd_config
    mode: "0644"
    validate: "/usr/sbin/sshd -t -f %s"
  notify: restart sshd

- name: Ensure firewall is installed (Debian/Ubuntu)
  ansible.builtin.apt:
    name: ufw
    state: present
  when:
    - ansible_os_family == "Debian"
    - firewall_enabled | default(true)

- name: Configure firewall rules
  community.general.ufw:
    rule: "{{ item.rule }}"
    port: "{{ item.port }}"
    proto: "{{ item.proto }}"
  loop: "{{ firewall_rules }}"
  when: firewall_enabled | default(true)

- name: Enable firewall
  community.general.ufw:
    state: enabled
  when: firewall_enabled | default(true)

- name: Set system hostname
  ansible.builtin.hostname:
    name: "{{ inventory_hostname }}"

- name: Configure hosts file
  ansible.builtin.template:
    src: hosts.j2
    dest: /etc/hosts
    mode: "0644"

- name: Create admin users
  ansible.builtin.user:
    name: "{{ item.name }}"
    groups: "{{ item.groups }}"
    shell: "{{ item.shell }}"
    create_home: true
  loop: "{{ linux_users }}"
  when: linux_users is defined
