---
# Base Windows configuration role - Main tasks

- name: Set timezone
  ansible.windows.win_timezone:
    timezone: "{{ timezone }}"

- name: Configure NTP servers
  ansible.windows.win_shell: |
    w32tm /config /manualpeerlist:"{{ ntp_servers | join(',') }}" /syncfromflags:manual /reliable:yes /update
    Restart-Service w32time

- name: Set computer name
  ansible.windows.win_hostname:
    name: "{{ inventory_hostname }}"
  register: hostname_change

- name: Reboot if hostname changed
  ansible.windows.win_reboot:
    reboot_timeout: 600
  when: hostname_change.reboot_required

- name: Configure Windows Firewall
  ansible.windows.win_firewall:
    state: "{{ 'enabled' if windows_firewall_enabled else 'disabled' }}"
    profiles:
      - Domain
      - Private
      - Public

- name: Install Windows features
  ansible.windows.win_feature:
    name: "{{ item }}"
    state: present
  loop: "{{ windows_features }}"
  when: windows_features is defined

- name: Set PowerShell execution policy
  ansible.windows.win_shell: |
    Set-ExecutionPolicy -ExecutionPolicy {{ powershell_execution_policy }} -Force
  changed_when: false

- name: Configure Windows Update settings
  ansible.windows.win_updates:
    category_names: "{{ windows_update_categories }}"
    state: installed
  when: windows_auto_update | default(false)

- name: Disable unnecessary services
  ansible.windows.win_service:
    name: "{{ item }}"
    state: stopped
    start_mode: disabled
  loop:
    # Xbox services (not needed on servers)
    - XblAuthManager
    # Print Spooler (security risk if not needed)
    - Spooler
    # Remote Registry (security risk)
    - RemoteRegistry
    # Windows Error Reporting (not needed on servers)
    - WerSvc
    # Retail Demo Service (not needed)
    - RetailDemo
    # Distributed Link Tracking Client (rarely needed)
    - TrkWks
    # Superfetch/SysMain (not beneficial on servers)
    - SysMain
    # Windows Search (resource intensive, rarely needed on servers)
    - WSearch
  failed_when: false

- name: Configure DNS client
  ansible.windows.win_dns_client:
    adapter_names: "*"
    dns_servers: "{{ dns_servers }}"
  when: dns_servers is defined
