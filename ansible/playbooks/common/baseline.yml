---
# Common configuration playbook for all hosts

- name: Common configuration for all systems
  hosts: all
  gather_facts: true
  tags:
    - common
    - baseline

  tasks:
    - name: Set timezone (Linux)
      community.general.timezone:
        name: "{{ timezone }}"
      when: ansible_os_family != "Windows"
      become: true

    - name: Set timezone (Windows)
      community.windows.win_timezone:
        timezone: "{{ timezone }}"
      when: ansible_os_family == "Windows"

    - name: Configure NTP servers (Linux)
      ansible.builtin.template:
        src: templates/ntp.conf.j2
        dest: /etc/ntp.conf
        mode: "0644"
      when: ansible_os_family != "Windows"
      become: true
      notify: restart ntp

    - name: Configure NTP servers (Windows)
      ansible.windows.win_shell: |
        w32tm /config /manualpeerlist:"{{ ntp_servers | join(',') }}" /syncfromflags:manual /reliable:yes /update
        Restart-Service w32time
      when: ansible_os_family == "Windows"

    - name: Ensure DNS servers are configured (Linux)
      ansible.builtin.template:
        src: templates/resolv.conf.j2
        dest: /etc/resolv.conf
        mode: "0644"
      when: ansible_os_family != "Windows"
      become: true

  handlers:
    - name: restart ntp
      ansible.builtin.service:
        name: "{{ 'ntp' if ansible_os_family == 'Debian' else 'ntpd' }}"
        state: restarted
      become: true
