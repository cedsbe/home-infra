---
# Active Directory configuration playbook

- name: Configure Active Directory Domain Controllers
  hosts: domain_controllers
  gather_facts: true
  tags:
    - ad
    - domain

  tasks:
    - name: Install AD DS role
      ansible.windows.win_feature:
        name: AD-Domain-Services
        include_management_tools: true
        state: present
      register: adds_install

    - name: Check if domain is already configured
      ansible.windows.win_shell: |
        Get-ADDomain -ErrorAction SilentlyContinue
      register: domain_check
      failed_when: false
      changed_when: false

    - name: Install new AD forest
      ansible.windows.win_domain:
        dns_domain_name: "{{ ad_domain_name }}"
        safe_mode_password: "{{ ad_safe_mode_password }}"
        domain_netbios_name: "{{ ad_netbios_name }}"
        forest_mode: "{{ ad_forest_mode }}"
        domain_mode: "{{ ad_domain_mode }}"
        install_dns: "{{ ad_install_dns }}"
      register: domain_install
      when: domain_check.rc != 0

    - name: Reboot after domain installation
      ansible.windows.win_reboot:
        reboot_timeout: 600
        post_reboot_delay: 60
      when: domain_install.changed

    - name: Configure DNS forwarders
      ansible.windows.win_shell: |
        {% for forwarder in ad_dns_forwarders %}
        Add-DnsServerForwarder -IPAddress {{ forwarder }}
        {% endfor %}
      when:
        - domain_install.changed
        - ad_dns_forwarders is defined

    - name: Display AD configuration status
      ansible.builtin.debug:
        msg: "Active Directory domain {{ ad_domain_name }} is configured"
